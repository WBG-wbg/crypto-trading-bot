# 分批止盈（Partial Take-Profit）使用说明

## 📋 概述

分批止盈系统基于原始止损距离（Risk Distance）自动计算多个止盈目标，并在达到目标时自动执行部分平仓。该系统采用**混合协同模式**，与追踪止损系统协同工作，确保利润最大化和风险控制。

## 🎯 核心特性

### 1. 基于风险回报比的止盈计算
- **风险距离（R）** = |入场价 - 原始止损价|
- **止盈目标** 基于风险回报比（1R, 2R, 3R）自动计算
- **自动适配** 多仓（long）和空仓（short）

### 2. 默认分批策略

```
级别 1（L1）: 30% 仓位 @ 1R 盈利 → 止损移至保本
级别 2（L2）: 30% 仓位 @ 2R 盈利 → 止损移至 L1 价位
级别 3（L3）: 40% 仓位 @ 3R 盈利 → 止损移至 L2 价位
```

### 3. 混合协同模式

**分批止盈 + 追踪止损** 同时运行，互相协调：

- ✅ **初期（未达到 L1）**: 追踪止损保护本金
- ✅ **L1 执行后**: 追踪止损底线 ≥ 保本价
- ✅ **L2 执行后**: 追踪止损底线 ≥ L1 价位
- ✅ **L3 执行后**: 追踪止损底线 ≥ L2 价位

## 💡 工作原理示例

### 多仓示例（Long Position）

```
入场价格:     $100
原始止损:     $95
风险距离:     $5 (1R)

分批止盈计划:
┌────────────────────────────────────────────────────────┐
│ L1: $105 (1R) → 平仓 30% → 止损移至 $100 (保本)       │
│ L2: $110 (2R) → 平仓 30% → 止损移至 $105 (L1 价位)    │
│ L3: $115 (3R) → 平仓 40% → 止损移至 $110 (L2 价位)    │
└────────────────────────────────────────────────────────┘

价格走势与系统响应:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

$95  ┤ 🛡️ 原始止损
$100 ┤ 📍 入场价格
$102 ┤ 📈 追踪止损自动上移（根据ATR）
$105 ┤ 🎯 L1 触发！平仓30% → 止损移至 $100 ✓
$108 ┤ 📈 追踪止损继续上移（但不会低于 $100）
$110 ┤ 🎯 L2 触发！平仓30% → 止损移至 $105 ✓
$113 ┤ 📈 追踪止损上移（但不会低于 $105）
$115 ┤ 🎯 L3 触发！平仓40% → 完全平仓 ✓✓✓
```

### 空仓示例（Short Position）

```
入场价格:     $100
原始止损:     $105
风险距离:     $5 (1R)

分批止盈计划:
┌────────────────────────────────────────────────────────┐
│ L1: $95 (1R)  → 平仓 30% → 止损移至 $100 (保本)       │
│ L2: $90 (2R)  → 平仓 30% → 止损移至 $95 (L1 价位)     │
│ L3: $85 (3R)  → 平仓 40% → 止损移至 $90 (L2 价位)     │
└────────────────────────────────────────────────────────┘

价格走势与系统响应:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

$105 ┤ 🛡️ 原始止损
$100 ┤ 📍 入场价格
$98  ┤ 📉 追踪止损自动下移（根据ATR）
$95  ┤ 🎯 L1 触发！平仓30% → 止损移至 $100 ✓
$92  ┤ 📉 追踪止损继续下移（但不会高于 $100）
$90  ┤ 🎯 L2 触发！平仓30% → 止损移至 $95 ✓
$87  ┤ 📉 追踪止损下移（但不会高于 $95）
$85  ┤ 🎯 L3 触发！平仓40% → 完全平仓 ✓✓✓
```

## 🔧 技术实现

### 核心组件

1. **TakeProfitManager** ([takeprofit_manager.go](../internal/executors/takeprofit_manager.go))
   - 管理分批止盈配置和执行
   - 计算风险回报比和目标价格
   - 提供最低止损底线（floor）

2. **StopLossManager** ([stoploss_manager.go](../internal/executors/stoploss_manager.go))
   - 集成 TakeProfitManager
   - 协调追踪止损和分批止盈
   - 定期调用 `MonitorPartialTakeProfit()`

### 关键方法

#### 1. 初始化分批止盈
```go
// 在持仓注册时自动调用
sm.takeProfitMgr.InitializeTakeProfitLevels(pos)
```

#### 2. 监控和执行止盈
```go
// 在每个交易间隔（如15分钟）调用
err := sm.MonitorPartialTakeProfit(ctx, symbol, currentPrice)
```

#### 3. 追踪止损协调
```go
// AutoUpdateTrailingStop 自动检查止盈底线
minStopLoss, hasFloor := sm.takeProfitMgr.GetMinimumStopLoss(pos)
if hasFloor && newStopLoss < minStopLoss {
    newStopLoss = minStopLoss // 应用底线保护
}
```

## 📊 数据结构

### Position 结构扩展
```go
type Position struct {
    // ... 其他字段 ...

    // 分批止盈配置
    TakeProfitConfig *TakeProfitConfig
}
```

### TakeProfitConfig
```go
type TakeProfitConfig struct {
    Enabled bool                // 是否启用
    Levels  []*TakeProfitLevel  // 止盈级别列表
}
```

### TakeProfitLevel
```go
type TakeProfitLevel struct {
    Level          int       // 级别编号 (1, 2, 3)
    RiskRewardRatio float64   // 风险回报比 (1.0, 2.0, 3.0)
    Percentage     float64   // 平仓比例 (0.3, 0.3, 0.4)
    TargetPrice    float64   // 目标价格
    Executed       bool      // 是否已执行
    ExecutedTime   *time.Time // 执行时间
    ExecutedPrice  float64   // 实际执行价格
    NewStopLoss    float64   // 执行后新止损价
}
```

## 🚀 使用方式

### 自动启用（默认）

分批止盈系统已集成到交易流程中，**无需额外配置**即可使用：

1. **开仓时**: 自动根据初始止损价计算止盈级别
2. **运行时**: 系统独立的实时监控服务持续检查价格并执行止盈（默认每 10 秒）
3. **止损协调**: 追踪止损自动尊重止盈底线

### 监控频率配置

分批止盈监控**独立于**主交易分析周期（如 15 分钟），实现真正的实时监控：

```bash
# 在 .env 文件中配置
TAKE_PROFIT_MONITORING_INTERVAL=10  # 监控间隔（秒），默认 10 秒
```

**推荐配置**：
- 🚀 **激进模式**：5 秒（更快响应，API 调用更频繁）
- ⚖️ **平衡模式**：10 秒（默认，推荐）
- 🐢 **保守模式**：30 秒（减少 API 调用）

### 查看止盈状态

日志输出会显示当前止盈状态：
```
【BTCUSDT】止盈状态: L1✅, L2⏳, L3⏳, 剩余仓位: 0.0070
```

图例：
- ✅ = 已执行
- ⏳ = 待执行

### 日志示例

```
【BTCUSDT】分批止盈已初始化 (风险距离: 500.00)
  级别 1: 30% @ $30500.00 (1.0R) → 止损移至 $30000.00
  级别 2: 30% @ $31000.00 (2.0R) → 止损移至 $30500.00
  级别 3: 40% @ $31500.00 (3.0R) → 止损移至 $31000.00

【BTCUSDT】🎯 触发止盈级别 1: 当前价 $30510.00 >= 目标价 $30500.00
✅【BTCUSDT】止盈级别 1 已执行: 平仓 0.0030 (30%) @ $30510.00, 盈亏: +153.00 USDT
【BTCUSDT】📌 准备更新止损: 29500.00 → 30000.00 (级别 1 后)
✅【BTCUSDT】止盈级别 1 完成，剩余仓位: 0.0070 (70%)
```

## ⚠️ 重要说明

### 1. 止盈执行顺序
- 分批止盈按顺序执行（L1 → L2 → L3）
- 每次只执行一个级别，避免快速连续平仓

### 2. 追踪止损协调
- 追踪止损始终运行，提供额外保护
- 止盈底线优先级 > 追踪止损计算值
- 确保已锁定的利润不会因追踪止损回撤而丢失

### 3. 风险管理
- 即使未达到止盈目标，追踪止损也会保护利润
- 建议的风险距离：账户权益的 1-2%
- 杠杆越高，风险距离应越小

### 4. 适用场景
✅ **适合**:
- 趋势明确的市场
- 波动性适中的币种
- 中长期持仓策略

❌ **不适合**:
- 高频交易
- 超短期scalping
- 极端波动行情

## 🔍 监控和调试

### 检查持仓状态
```go
pos := stopLossManager.GetPosition(symbol)
if pos.TakeProfitConfig != nil {
    for _, level := range pos.TakeProfitConfig.Levels {
        fmt.Printf("L%d: 目标=%.2f, 已执行=%v\n",
            level.Level, level.TargetPrice, level.Executed)
    }
}
```

### 查看止盈底线
```go
minStopLoss, hasFloor := takeProfitMgr.GetMinimumStopLoss(pos)
if hasFloor {
    fmt.Printf("当前止损底线: %.2f\n", minStopLoss)
}
```

## 🎨 自定义配置（高级）

如需修改分批止盈策略，可编辑 [takeprofit_manager.go:InitializeTakeProfitLevels()](../internal/executors/takeprofit_manager.go)：

```go
// 示例：修改为 4 个级别
levels := []*TakeProfitLevel{
    {Level: 1, RiskRewardRatio: 1.0, Percentage: 0.25}, // 25% @ 1R
    {Level: 2, RiskRewardRatio: 2.0, Percentage: 0.25}, // 25% @ 2R
    {Level: 3, RiskRewardRatio: 3.0, Percentage: 0.25}, // 25% @ 3R
    {Level: 4, RiskRewardRatio: 4.0, Percentage: 0.25}, // 25% @ 4R
}
```

## 📈 性能优化建议

1. **监控间隔**:
   - 默认 10 秒，在响应速度和 API 调用之间取得平衡
   - 快速行情建议 5 秒，慢速市场可设为 30 秒
   - 独立于主交易分析周期，不受 15 分钟限制
2. **ATR 周期**: 使用 ATR(7) 用于追踪止损
3. **更新阈值**: 止损变化 < 0.5% 时跳过更新，减少 API 调用

## 🆘 常见问题

### Q1: 分批止盈会影响追踪止损吗？
**A**: 不会冲突。追踪止损会自动尊重分批止盈设置的底线，两者协同工作。

### Q2: 如果价格快速上涨，会连续触发多个级别吗？
**A**: 不会。系统每次调用只执行一个级别，下次调用时才检查下一个级别。

### Q3: 分批止盈执行失败怎么办？
**A**: 系统会记录错误日志，保留原止损单，不会影响其他级别的监控。

### Q4: 可以禁用分批止盈吗？
**A**: 可以。在 `RegisterPosition` 之后设置 `pos.TakeProfitConfig.Enabled = false`。

### Q5: 止盈后的剩余仓位如何管理？
**A**: 剩余仓位继续受追踪止损保护，且止损底线已提升到更安全的位置。

## 📝 更新日志

### v1.1.0 (2025-12-04)
- ✅ 实现独立实时监控服务（独立于主交易周期）
- ✅ 添加可配置监控间隔参数（TAKE_PROFIT_MONITORING_INTERVAL）
- ✅ 默认 10 秒监控，可快速响应市场波动
- ✅ 修复快速行情下止损来不及的问题

### v1.0.0 (2025-12-04)
- ✅ 初始版本发布
- ✅ 实现基于风险回报比的分批止盈
- ✅ 集成追踪止损协同模式
- ✅ 支持多仓和空仓

---

**维护者**: Trading Bot Development Team
**更新日期**: 2025-12-04
**相关文件**:
- [takeprofit_manager.go](../internal/executors/takeprofit_manager.go)
- [stoploss_manager.go](../internal/executors/stoploss_manager.go)
- [binance_executor.go](../internal/executors/binance_executor.go)
